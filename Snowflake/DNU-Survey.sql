
create temp table tt_exit_survey as 
select Record_Date,
Start_Datetime,
End_Datetime,
Status,
Progress,
Duration,
Finished,
Recorded_Date,
up.Response_Id,
Termination_Date,
up.Employee_ID,
Q3_374,
Q3_376,
Q3_378,
Q3_388,
Q3_386,
Q3_380,
Q3_381,
Q3_382,
Q3_375,
Q3_377,
Q3_379,
Q3_383,
Q3_384,
Q3_385,
Q3_387,
Q4,
Q6,
Q6_4,
Q6_5,
Q6_6,
Q6_7,
Q6_8,
Q6_9,
Q6_10,
Q6_11,
Q6_12,
Q6_13,
Q6_14,
Q6_15,
Q6_15_TEXT,
Q7,
Q9,
Q9_29,
Q9_30,
Q9_31,
Q9_32,
Q9_33,
Q9_34,
Q9_41,
Q9_35,
Q9_36,
Q9_37,
Q9_38,
Q9_39,
Q9_40,
Q9_41_TEXT,
Q10,
Q12,
Q12_61,
Q12_62,
Q12_63,
Q12_64,
Q12_65,
Q12_66,
Q12_67,
Q12_68,
Q12_69,
Q12_79,
Q12_70,
Q12_71,
Q12_72,
Q12_73,
Q12_74,
Q12_75,
Q12_76,
Q12_77,
Q12_78,
Q12_79_TEXT,
Q13,
Q15,
Q15_80,
Q15_81,
Q15_82,
Q15_83,
Q15_88,
Q15_84,
Q15_85,
Q15_86,
Q15_87,
Q15_88_TEXT,
Q16,
Q18,
Q19,
Q20,
Q21,
Q23,
Q23_4,
Q23_5,
Q23_6,
Q23_7,
Q23_8,
Q23_9,
Q23_10,
Q23_11,
Q23_12,
Q23_13,
Q23_13_TEXT,
Q24,
Q31,
Q27,
Q28,
Q32,
Q33,
Q33_4,
Q33_5,
Q33_6,
Q33_7,
Q33_8,
Q33_9,
Q33_10,
Q33_11,
Q33_12,
Q33_13,
Q33_13_TEXT,
Q34,
Q35,
Q36,
Q37,
Q39_1_A,
Q39_2_A,
Q39_3_A,
Q39_4_A,
Q39_5_A,
Q39_6_A,
Q39_7_A,
Q39_8_A,
Q39_1_B,
Q39_2_B,
Q39_3_B,
Q39_4_B,
Q39_5_B,
Q39_6_B,
Q39_7_B,
Q39_8_B,
Q39_9_A,
Q39_10_A,
Q39_11_A,
Q39_12_A,
Q39_13_A,
Q39_14_A,
Q39_15_A,
Q39_16_A,
Q39_9_B,
Q39_10_B,
Q39_11_B,
Q39_12_B,
Q39_13_B,
Q39_14_B,
Q39_15_B,
Q39_16_B,
Q39_17_A,
Q39_18_A,
Q39_19_A,
Q39_20_A,
Q39_21_A,
Q39_22_A,
Q39_23_A,
Q40_24_A,
Q39_17_B,
Q39_18_B,
Q39_19_B,
Q39_20_B,
Q39_21_B,
Q39_22_B,
Q39_23_B,
Q40_24_B,
Q39_25_A,
Q39_26_A,
Q39_27_A,
Q39_28_A,
Q39_29_A,
Q39_30_A,
Q39_31_A,
Q43_44_A,
Q39_25_B,
Q39_26_B,
Q39_27_B,
Q39_28_B,
Q39_29_B,
Q39_30_B,
Q39_31_B,
Q43_44_B,
Q44  from (select 
Response_Id,
Employee_ID,
Q33,NULL as Q9,NULL as Q15,NULL as Q12,NULL as Q23,NULL as Q6 from  "PO_HRIS_DB"."survey".po_exit_survey e unpivot (Q33 for Q33_S IN (Q33_4,
Q33_5,
Q33_6,
Q33_7,
Q33_8,
Q33_9,
Q33_10,
Q33_11,
Q33_12,
Q33_13 ) ) as Unpivoted_Q33
//where response_id = 'R_2WMxZTniXjyfDYM'
union all
select Response_Id,
Employee_ID,
NULL,Q9 ,NULL ,NULL ,NULL ,NULL from  "PO_HRIS_DB"."survey".po_exit_survey e
unpivot (Q9 for Q9_S IN (Q9_29,
Q9_30,
Q9_31,
Q9_32,
Q9_33,
Q9_34,
Q9_41,
Q9_35,
Q9_36,
Q9_37,
Q9_38,
Q9_39,
Q9_40 ) )
//where response_id = 'R_2WMxZTniXjyfDYM'
union all
select Response_Id,
Employee_ID,
NULL,NULL ,Q15 ,NULL ,NULL ,NULL  from  "PO_HRIS_DB"."survey".po_exit_survey a
unpivot (Q15 for Q15_S IN (Q15_80,
Q15_81,
Q15_82,
Q15_83,
Q15_88,
Q15_84,
Q15_85,
Q15_86,
Q15_87 ) )
//where a.response_id = 'R_2WMxZTniXjyfDYM'
union all
select Response_Id,
Employee_ID,
NULL,NULL ,NULL ,Q12 ,NULL ,NULL from  "PO_HRIS_DB"."survey".po_exit_survey e
unpivot (Q12 for Q12_S IN (Q12_61,
Q12_62,
Q12_63,
Q12_64,
Q12_65,
Q12_66,
Q12_67,
Q12_68,
Q12_69,
Q12_79,
Q12_70,
Q12_71,
Q12_72,
Q12_73,
Q12_74,
Q12_75,
Q12_76,
Q12_77,
Q12_78) )
//select * from  "PO_HRIS_DB"."survey".po_exit_survey 
//where response_id = 'R_2WMxZTniXjyfDYM'
union all
select
Response_Id,
Employee_ID,
NULL,NULL ,NULL ,NULL ,Q23 ,NULL from  "PO_HRIS_DB"."survey".po_exit_survey e
unpivot (Q23 for Q23_S IN (Q23_4,
Q23_5,
Q23_6,
Q23_7,
Q23_8,
Q23_9,
Q23_10,
Q23_11,
Q23_12,
Q23_13) )
union all
select Response_Id,
Employee_ID,
NULL,NULL ,NULL ,NULL ,NULL ,Q6 from  "PO_HRIS_DB"."survey".po_exit_survey e
unpivot (Q6 for Q6_S IN (Q6_4,
Q6_5,
Q6_6,
Q6_7,
Q6_8,
Q6_9,
Q6_10,
Q6_11,
Q6_12,
Q6_13,
Q6_14,
Q6_15) )
) up LEFT JOIN (select Record_Date,
Start_Datetime,
End_Datetime,
Status,
Progress,
Duration,
Finished,
Recorded_Date,
Response_Id,
Termination_Date,
Employee_ID,
Q3_374,
Q3_376,
Q3_378,
Q3_388,
Q3_386,
Q3_380,
Q3_381,
Q3_382,
Q3_375,
Q3_377,
Q3_379,
Q3_383,
Q3_384,
Q3_385,
Q3_387,
Q4,
Q6_4,
Q6_5,
Q6_6,
Q6_7,
Q6_8,
Q6_9,
Q6_10,
Q6_11,
Q6_12,
Q6_13,
Q6_14,
Q6_15,
Q6_15_TEXT,
Q7,
Q9_29,
Q9_30,
Q9_31,
Q9_32,
Q9_33,
Q9_34,
Q9_41,
Q9_35,
Q9_36,
Q9_37,
Q9_38,
Q9_39,
Q9_40,
Q9_41_TEXT,
Q10,
Q12_61,
Q12_62,
Q12_63,
Q12_64,
Q12_65,
Q12_66,
Q12_67,
Q12_68,
Q12_69,
Q12_79,
Q12_70,
Q12_71,
Q12_72,
Q12_73,
Q12_74,
Q12_75,
Q12_76,
Q12_77,
Q12_78,
Q12_79_TEXT,
Q13,
Q15_80,
Q15_81,
Q15_82,
Q15_83,
Q15_88,
Q15_84,
Q15_85,
Q15_86,
Q15_87,
Q15_88_TEXT,
Q16,
Q18,
Q19,
Q20,
Q21,
Q23_4,
Q23_5,
Q23_6,
Q23_7,
Q23_8,
Q23_9,
Q23_10,
Q23_11,
Q23_12,
Q23_13,
Q23_13_TEXT,
Q24,
Q31,
Q27,
Q28,
Q32,
Q33_4,
Q33_5,
Q33_6,
Q33_7,
Q33_8,
Q33_9,
Q33_10,
Q33_11,
Q33_12,
Q33_13,
Q33_13_TEXT,
Q34,
Q35,
Q36,
Q37,
Q39_1_A,
Q39_2_A,
Q39_3_A,
Q39_4_A,
Q39_5_A,
Q39_6_A,
Q39_7_A,
Q39_8_A,
Q39_1_B,
Q39_2_B,
Q39_3_B,
Q39_4_B,
Q39_5_B,
Q39_6_B,
Q39_7_B,
Q39_8_B,
Q39_9_A,
Q39_10_A,
Q39_11_A,
Q39_12_A,
Q39_13_A,
Q39_14_A,
Q39_15_A,
Q39_16_A,
Q39_9_B,
Q39_10_B,
Q39_11_B,
Q39_12_B,
Q39_13_B,
Q39_14_B,
Q39_15_B,
Q39_16_B,
Q39_17_A,
Q39_18_A,
Q39_19_A,
Q39_20_A,
Q39_21_A,
Q39_22_A,
Q39_23_A,
Q40_24_A,
Q39_17_B,
Q39_18_B,
Q39_19_B,
Q39_20_B,
Q39_21_B,
Q39_22_B,
Q39_23_B,
Q40_24_B,
Q39_25_A,
Q39_26_A,
Q39_27_A,
Q39_28_A,
Q39_29_A,
Q39_30_A,
Q39_31_A,
Q43_44_A,
Q39_25_B,
Q39_26_B,
Q39_27_B,
Q39_28_B,
Q39_29_B,
Q39_30_B,
Q39_31_B,
Q43_44_B,
Q44 from "PO_HRIS_DB"."survey".po_exit_survey) E on e.Employee_ID = up.Employee_ID and e.response_id = up.response_id ;

//select * from wd_exit_data
create temp table tt_wd_exit as
 Select 
     DATE_TRUNC('MONTH', date) Start_date,
     date as End_date,
     fiscal_year,
     fy_quarter,
     //month_end,
     //quarter_end,
     ss.employee_id,
     ss.workday_id,
     business_title,
     business_unit,
     division,
     sub_division,
     dept,
     sub_dept,
     work_country,
     region,
     employee_type,
     org_level,
     business_partner,
     manager_work_email,
     gender,
     race_ethnicity,
     time_in_job,
     active_status,
     termination_dt as Effective_date,
     termination_dt_all,
     hire_dt,
     original_hire_dt,
     continuous_service_dt,
     round(months_between(termination_dt,hire_dt )) as Length_Of_Service,
     generation,
     termination_reason,
     benefit_code,
     job_family,
     job_family_grp
     
 from 
 PO_HRIS_DB."Calender".DIM_DATE dd INNER JOIN PO_HRIS_DB."Worker".PO_Worker_Snapshot ss on End_Date = ss.snapshot_dt //and ss.termination_dt is not null //and active_status = 'FALSE'
and ifnull(ss.termination_dt,'9999-12-31') between Start_date and End_date
 where dd.fiscal_year >= 2020 and dd.month_end 
 and ifnull(ss.benefit_code,'abc') NOT IN ('N1','N3','A3','A4','A9','A8','B4','B5','B6','N7','A2','A6','N5') 
and ss.employee_type IN ('Contract - CATS','Limited Term','Regular','Union','Union-Limited Term','Wholly Owned Subsidiary')  
//and workday_id = '1af97682e7e94785a0fba815c3f0e456'
;

 select * from tt_wd_exit we 
 left join 
 select * from tt_exit_survey es on we

//select count(*),employee_id from  "PO_HRIS_DB"."survey".po_exit_survey e group by 2 having count(*) > 1