create or replace pipe PO_STAGE_DB."survey".p_exit_survey_load 
auto_ingest = true 
as
copy into "PO_STAGE_DB"."survey".po_exit_survey_stage
from (select 
$1,
$2,
$3,
$4,
$5,
$6,
$7,
$8,
$9,
$10,
$11,
$12,
$13,
$14,
$15,
$16,
$17,
$18,
$19,
$20,
$21,
$22,
$23,
$24,
$25,
$26,
$27,
$28,
$29,
$30,
$31,
$32,
$33,
$34,
$35,
$36,
$37,
$38,
$39,
$40,
$41,
$42,
$43,
$44,
$45,
$46,
$47,
$48,
$49,
$50,
$51,
$52,
$53,
$54,
$55,
$56,
$57,
$58,
$59,
$60,
$61,
$62,
$63,
$64,
$65,
$66,
$67,
$68,
$69,
$70,
$71,
$72,
$73,
$74,
$75,
$76,
$77,
$78,
$79,
$80,
$81,
$82,
$83,
$84,
$85,
$86,
$87,
$88,
$89,
$90,
$91,
$92,
$93,
$94,
$95,
$96,
$97,
$98,
$99,
$100,
$101,
$102,
$103,
$104,
$105,
$106,
$107,
$108,
$109,
$110,
$111,
$112,
$113,
$114,
$115,
$116,
$117,
$118,
$119,
$120,
$121,
$122,
$123,
$124,
$125,
$126,
$127,
$128,
$129,
$130,
$131,
$132,
$133,
$134,
$135,
$136,
$137,
$138,
$139,
$140,
$141,
$142,
$143,
$144,
$145,
$146,
$147,
$148,
$149,
$150,
$151,
$152,
$153,
$154,
$155,
$156,
$157,
$158,
$159,
$160,
$161,
$162,
$163,
$164,
$165,
$166,
$167,
$168,
$169,
$170,
$171,
$172,
$173,
$174,
$175,
$176,
$177,
$178,
$179,
$180,
$181,
$182,
$183,
$184,
$185,
$186,
$187,
$188,
METADATA$FILENAME
from @PO_STAGE_DB.PUBLIC.MY_S3_STAGE)
pattern = '.*QL_Survey_Exit_Interview_20240515.*_hashed.*csv'
FILE_FORMAT = (  FORMAT_NAME = 'PO_STAGE_DB."Worker".csv_load_format'  TYPE = CSV ) 
;

/*stream for exit*/
create or replace stream PO_STAGE_DB."survey".S_EXIT_SURVEY_LOAD
COPY GRANTS on table "PO_STAGE_DB"."survey".po_exit_survey_stage
APPEND_ONLY = TRUE
;

/*Task for Exit*/
create or replace task PO_HRIS_DB."survey".t_exit_survey_load
Warehouse = po_wh
SCHEDULE = 'USING CRON 0 16-17 * * * America/Chicago'
//Schedule = '1 Minute'
when system$stream_has_data('PO_STAGE_DB."survey".S_EXIT_SURVEY_LOAD')
as 
Call sp_exit_survey_load((to_char(current_date -1,'YYYYMMDD') )::int)
;

SELECT SYSTEM$PIPE_STATUS('PO_STAGE_DB."survey".p_exit_survey_load');
select * from "PO_HRIS_DB"."survey".po_exit_survey
{"executionState":"RUNNING","pendingFileCount":0,"notificationChannelName":"arn:aws:sqs:us-west-2:774708397847:sf-snowpipe-AIDA3IYBYA4L4SILECDOM-aNkeKZnVEdL-KrxSmU0A-w","numOutstandingMessagesOnChannel":1,"lastReceivedMessageTimestamp":"2024-01-16T05:28:58.227Z","lastPulledFromChannelTimestamp":"2024-01-16T06:37:13.173Z"}

ALTER TASK T_EXIT_SURVEY_LOAD RESUME;
ALTER TASK T_EXIT_SURVEY_LOAD suspend;

SHOW TASKS LIKE 't_exit_survey_load';


CREATE OR REPLACE PROCEDURE sp_exit_survey_load(Batch_ID int)
  RETURNS VARCHAR
  LANGUAGE SQL
  EXECUTE AS CALLER
  AS
  $$
  
declare
record_date date;
created_datetime timestamp;
modified_datetime timestamp;
created_by string;
modified_by string;
sp_name string;


begin


record_date := current_date();
created_datetime := current_timestamp(); 
modified_datetime := current_timestamp(); 
created_by := current_user();
modified_by :=  current_user();
sp_name :=  'sp_exit_survey_load';

//temp table

create or replace temp table tmp_exit as
Select ass.*, row_number() over( partition by response_id order by filename desc) as rnk
from "PO_STAGE_DB"."survey".po_exit_survey_stage ass
;

//data load from staging 

//Call sp_auditevent (:load_id,'po_exit_survey_stage','started','load data from s3 to staging table')

//05/16/2024 3:05 PM- Earlier version


INSERT INTO "PO_HRIS_DB"."survey".po_exit_survey
(
Record_Date,
Start_Datetime,
End_Datetime,
Status,
Progress,
Duration,
Finished,
Recorded_Date,
Response_Id,
Termination_Date,
Employee_ID,
Q3_374,
Q3_376,
Q3_378,
Q3_388,
Q3_386,
Q3_380,
Q3_381,
Q3_382,
Q3_375,
Q3_377,
Q3_379,
Q3_383,
Q3_384,
Q3_385,
Q3_387,
Q4,
Q6_4,
Q6_5,
Q6_6,
Q6_7,
Q6_8,
Q6_9,
Q6_10,
Q6_11,
Q6_12,
Q6_13,
Q6_14,
Q6_15,
Q6_15_TEXT,
Q7,
Q9_29,
Q9_30,
Q9_31,
Q9_32,
Q9_33,
Q9_34,
Q9_41,
Q9_35,
Q9_36,
Q9_37,
Q9_38,
Q9_39,
Q9_40,
Q9_41_TEXT,
Q10,
Q12_61,
Q12_62,
Q12_63,
Q12_64,
Q12_65,
Q12_66,
Q12_67,
Q12_68,
Q12_69,
Q12_79,
Q12_70,
Q12_71,
Q12_72,
Q12_73,
Q12_74,
Q12_75,
Q12_76,
Q12_77,
Q12_78,
Q12_79_TEXT,
Q13,
Q15_80,
Q15_81,
Q15_82,
Q15_83,
Q15_88,
Q15_84,
Q15_85,
Q15_86,
Q15_87,
Q15_88_TEXT,
Q16,
Q18,
Q19,
Q20,
Q21,
Q23_4,
Q23_5,
Q23_6,
Q23_7,
Q23_8,
Q23_9,
Q23_10,
Q23_11,
Q23_12,
Q23_13,
Q23_13_TEXT,
Q24,
Q31,
Q27,
Q28,
Q32,
Q33_4,
Q33_5,
Q33_6,
Q33_7,
Q33_8,
Q33_9,
Q33_10,
Q33_11,
Q33_12,
Q33_13,
Q33_13_TEXT,
Q34,
Q35,
Q36,
Q37,
Q39_1_A,
Q39_2_A,
Q39_3_A,
Q39_4_A,
Q39_5_A,
Q39_6_A,
Q39_7_A,
Q39_8_A,
Q39_1_B,
Q39_2_B,
Q39_3_B,
Q39_4_B,
Q39_5_B,
Q39_6_B,
Q39_7_B,
Q39_8_B,
Q39_9_A,
Q39_10_A,
Q39_11_A,
Q39_12_A,
Q39_13_A,
Q39_14_A,
Q39_15_A,
Q39_16_A,
Q39_9_B,
Q39_10_B,
Q39_11_B,
Q39_12_B,
Q39_13_B,
Q39_14_B,
Q39_15_B,
Q39_16_B,
Q39_17_A,
Q39_18_A,
Q39_19_A,
Q39_20_A,
Q39_21_A,
Q39_22_A,
Q39_23_A,
Q40_24_A,
Q39_17_B,
Q39_18_B,
Q39_19_B,
Q39_20_B,
Q39_21_B,
Q39_22_B,
Q39_23_B,
Q40_24_B,
Q39_25_A,
Q39_26_A,
Q39_27_A,
Q39_28_A,
Q39_29_A,
Q39_30_A,
Q39_31_A,
Q43_44_A,
Q39_25_B,
Q39_26_B,
Q39_27_B,
Q39_28_B,
Q39_29_B,
Q39_30_B,
Q39_31_B,
Q43_44_B,
Q44,
Source_Filename,
Created_Datetime ,
Created_By,
Modified_Datetime ,
Modified_By,
Batch_ID 
)

select 
:record_date,
to_timestamp(exs.Start_Date),
to_timestamp(exs.End_Date),
exs.Status,
exs.Progress,
exs.Duration,
exs.Finished,
to_timestamp(exs.Recorded_Date),
exs.Response_Id,
exs.Termination_Date::Date,
coalesce(decode (exs.Employee_ID,'a69f73cca23a9ac5c8b567dc185a756e97c982164fe25859e0d1dcc1475c80a615b2123af1f5f94c11e3e9402c3ac558f500199d95b6d3e301758586281dcd26',null),exs.Participant_Unique_Identifier) as Employee_ID,
exs.Q3_374,
exs.Q3_376,
exs.Q3_378,
exs.Q3_388,
exs.Q3_386,
exs.Q3_380,
exs.Q3_381,
exs.Q3_382,
exs.Q3_375,
exs.Q3_377,
exs.Q3_379,
exs.Q3_383,
exs.Q3_384,
exs.Q3_385,
exs.Q3_387,
exs.Q4,
exs.Q6_4,
exs.Q6_5,
exs.Q6_6,
exs.Q6_7,
exs.Q6_8,
exs.Q6_9,
exs.Q6_10,
exs.Q6_11,
exs.Q6_12,
exs.Q6_13,
exs.Q6_14,
exs.Q6_15,
exs.Q6_15_TEXT,
exs.Q7,
exs.Q9_29,
exs.Q9_30,
exs.Q9_31,
exs.Q9_32,
exs.Q9_33,
exs.Q9_34,
exs.Q9_41,
exs.Q9_35,
exs.Q9_36,
exs.Q9_37,
exs.Q9_38,
exs.Q9_39,
exs.Q9_40,
exs.Q9_41_TEXT,
exs.Q10,
exs.Q12_61,
exs.Q12_62,
exs.Q12_63,
exs.Q12_64,
exs.Q12_65,
exs.Q12_66,
exs.Q12_67,
exs.Q12_68,
exs.Q12_69,
exs.Q12_79,
exs.Q12_70,
exs.Q12_71,
exs.Q12_72,
exs.Q12_73,
exs.Q12_74,
exs.Q12_75,
exs.Q12_76,
exs.Q12_77,
exs.Q12_78,
exs.Q12_79_TEXT,
exs.Q13,
exs.Q15_80,
exs.Q15_81,
exs.Q15_82,
exs.Q15_83,
exs.Q15_88,
exs.Q15_84,
exs.Q15_85,
exs.Q15_86,
exs.Q15_87,
exs.Q15_88_TEXT,
exs.Q16,
exs.Q18,
exs.Q19,
exs.Q20,
exs.Q21,
exs.Q23_4,
exs.Q23_5,
exs.Q23_6,
exs.Q23_7,
exs.Q23_8,
exs.Q23_9,
exs.Q23_10,
exs.Q23_11,
exs.Q23_12,
exs.Q23_13,
exs.Q23_13_TEXT,
exs.Q24,
exs.Q31,
exs.Q27,
exs.Q28,
exs.Q32,
exs.Q33_4,
exs.Q33_5,
exs.Q33_6,
exs.Q33_7,
exs.Q33_8,
exs.Q33_9,
exs.Q33_10,
exs.Q33_11,
exs.Q33_12,
exs.Q33_13,
exs.Q33_13_TEXT,
exs.Q34,
exs.Q35,
exs.Q36,
exs.Q37,
exs.Q39_1_A,
exs.Q39_2_A,
exs.Q39_3_A,
exs.Q39_4_A,
exs.Q39_5_A,
exs.Q39_6_A,
exs.Q39_7_A,
exs.Q39_8_A,
exs.Q39_1_B,
exs.Q39_2_B,
exs.Q39_3_B,
exs.Q39_4_B,
exs.Q39_5_B,
exs.Q39_6_B,
exs.Q39_7_B,
exs.Q39_8_B,
exs.Q39_9_A,
exs.Q39_10_A,
exs.Q39_11_A,
exs.Q39_12_A,
exs.Q39_13_A,
exs.Q39_14_A,
exs.Q39_15_A,
exs.Q39_16_A,
exs.Q39_9_B,
exs.Q39_10_B,
exs.Q39_11_B,
exs.Q39_12_B,
exs.Q39_13_B,
exs.Q39_14_B,
exs.Q39_15_B,
exs.Q39_16_B,
exs.Q39_17_A,
exs.Q39_18_A,
exs.Q39_19_A,
exs.Q39_20_A,
exs.Q39_21_A,
exs.Q39_22_A,
exs.Q39_23_A,
exs.Q40_24_A,
exs.Q39_17_B,
exs.Q39_18_B,
exs.Q39_19_B,
exs.Q39_20_B,
exs.Q39_21_B,
exs.Q39_22_B,
exs.Q39_23_B,
exs.Q40_24_B,
exs.Q39_25_A,
exs.Q39_26_A,
exs.Q39_27_A,
exs.Q39_28_A,
exs.Q39_29_A,
exs.Q39_30_A,
exs.Q39_31_A,
exs.Q43_44_A,
exs.Q39_25_B,
exs.Q39_26_B,
exs.Q39_27_B,
exs.Q39_28_B,
exs.Q39_29_B,
exs.Q39_30_B,
exs.Q39_31_B,
exs.Q43_44_B,
exs.Q44,
exs.Filename,
:created_datetime ,
:created_by ,
:modified_datetime ,
:modified_by ,
:Batch_ID 
FROM tmp_exit exs LEFT JOIN "PO_HRIS_DB"."survey".po_exit_survey ex on ex.response_id = exs.response_id 
where ex.response_id is null and rnk = 1;

Truncate table "PO_STAGE_DB"."survey".po_exit_survey_stage;

Return 'Done';

  END;
  $$;