create or replace TABLE PO_STAGE_DB."survey".PO_EXIT_SURVEY_STAGE (
	START_DATE VARCHAR(20),
	END_DATE VARCHAR(20),
	STATUS VARCHAR(10),
	PROGRESS VARCHAR(10),
	DURATION VARCHAR(10),
	FINISHED VARCHAR(10),
	RECORDED_DATE VARCHAR(20),
	RESPONSE_ID VARCHAR(20),
	Q3_374 VARCHAR(40),
	Q3_376 VARCHAR(90),
	Q3_378 VARCHAR(50),
	Q3_388 VARCHAR(30),
	Q3_386 VARCHAR(10),
	Q3_380 VARCHAR(50),
	Q3_381 VARCHAR(40),
	Q3_382 VARCHAR(30),
	Q3_375 VARCHAR(50),
	Q3_377 VARCHAR(70),
	Q3_379 VARCHAR(40),
	Q3_383 VARCHAR(30),
	Q3_384 VARCHAR(30),
	Q3_385 VARCHAR(10),
	Q3_387 VARCHAR(60),
	Q4 VARCHAR(90),
	Q6_4 VARCHAR(110),
	Q6_5 VARCHAR(80),
	Q6_6 VARCHAR(70),
	Q6_7 VARCHAR(80),
	Q6_8 VARCHAR(60),
	Q6_9 VARCHAR(100),
	Q6_10 VARCHAR(80),
	Q6_11 VARCHAR(110),
	Q6_12 VARCHAR(80),
	Q6_13 VARCHAR(80),
	Q6_14 VARCHAR(110),
	Q6_15 VARCHAR(30),
	Q6_15_TEXT VARCHAR,
	Q7 VARCHAR,
	Q9_29 VARCHAR(40),
	Q9_30 VARCHAR(50),
	Q9_31 VARCHAR(60),
	Q9_32 VARCHAR(100),
	Q9_33 VARCHAR(30),
	Q9_34 VARCHAR(40),
	Q9_41 VARCHAR(30),
	Q9_35 VARCHAR(30),
	Q9_36 VARCHAR(20),
	Q9_37 VARCHAR(30),
	Q9_38 VARCHAR(40),
	Q9_39 VARCHAR(30),
	Q9_40 VARCHAR(30),
	Q9_41_TEXT VARCHAR,
	Q10 VARCHAR,
	Q12_61 VARCHAR(30),
	Q12_62 VARCHAR(50),
	Q12_63 VARCHAR(60),
	Q12_64 VARCHAR(20),
	Q12_65 VARCHAR(60),
	Q12_66 VARCHAR(20),
	Q12_67 VARCHAR(20),
	Q12_68 VARCHAR(30),
	Q12_69 VARCHAR(50),
	Q12_79 VARCHAR(30),
	Q12_70 VARCHAR(30),
	Q12_71 VARCHAR(30),
	Q12_72 VARCHAR(50),
	Q12_73 VARCHAR(100),
	Q12_74 VARCHAR(100),
	Q12_75 VARCHAR(100),
	Q12_76 VARCHAR(100),
	Q12_77 VARCHAR(20),
	Q12_78 VARCHAR(30),
	Q12_79_TEXT VARCHAR,
	Q13 VARCHAR,
	Q15_80 VARCHAR(60),
	Q15_81 VARCHAR(90),
	Q15_82 VARCHAR(90),
	Q15_83 VARCHAR(60),
	Q15_88 VARCHAR(30),
	Q15_84 VARCHAR(50),
	Q15_85 VARCHAR(80),
	Q15_86 VARCHAR(100),
	Q15_87 VARCHAR(80),
	Q15_88_TEXT VARCHAR,
	Q16 VARCHAR(1460),
	Q18 VARCHAR(1250),
	Q19 VARCHAR(660),
	Q20 VARCHAR(20),
	Q21 VARCHAR(70),
	Q23_4 VARCHAR(60),
	Q23_5 VARCHAR(100),
	Q23_6 VARCHAR(50),
	Q23_7 VARCHAR(30),
	Q23_8 VARCHAR(30),
	Q23_9 VARCHAR(30),
	Q23_10 VARCHAR(20),
	Q23_11 VARCHAR(30),
	Q23_12 VARCHAR(40),
	Q23_13 VARCHAR(30),
	Q23_13_TEXT VARCHAR,
	Q24 VARCHAR,
	Q31 VARCHAR(70),
	Q27 VARCHAR(10),
	Q28 VARCHAR(110),
	Q32 VARCHAR,
	Q33_4 VARCHAR(60),
	Q33_5 VARCHAR(60),
	Q33_6 VARCHAR(80),
	Q33_7 VARCHAR(60),
	Q33_8 VARCHAR(70),
	Q33_9 VARCHAR(70),
	Q33_10 VARCHAR(60),
	Q33_11 VARCHAR(60),
	Q33_12 VARCHAR(100),
	Q33_13 VARCHAR(30),
	Q33_13_TEXT VARCHAR,
	Q34 VARCHAR(160),
	Q35 VARCHAR(30),
	Q36 VARCHAR,
	Q37 VARCHAR,
	Q39_1_A VARCHAR(40),
	Q39_2_A VARCHAR(40),
	Q39_3_A VARCHAR(40),
	Q39_4_A VARCHAR(40),
	Q39_5_A VARCHAR(40),
	Q39_6_A VARCHAR(40),
	Q39_7_A VARCHAR(40),
	Q39_8_A VARCHAR(40),
	Q39_1_B VARCHAR(20),
	Q39_2_B VARCHAR(20),
	Q39_3_B VARCHAR(20),
	Q39_4_B VARCHAR(20),
	Q39_5_B VARCHAR(20),
	Q39_6_B VARCHAR(20),
	Q39_7_B VARCHAR(20),
	Q39_8_B VARCHAR(20),
	Q39_9_A VARCHAR(40),
	Q39_10_A VARCHAR(40),
	Q39_11_A VARCHAR(40),
	Q39_12_A VARCHAR(40),
	Q39_13_A VARCHAR(40),
	Q39_14_A VARCHAR(40),
	Q39_15_A VARCHAR(40),
	Q39_16_A VARCHAR(40),
	Q39_9_B VARCHAR(20),
	Q39_10_B VARCHAR(20),
	Q39_11_B VARCHAR(20),
	Q39_12_B VARCHAR(20),
	Q39_13_B VARCHAR(20),
	Q39_14_B VARCHAR(20),
	Q39_15_B VARCHAR(20),
	Q39_16_B VARCHAR(20),
	Q39_17_A VARCHAR(40),
	Q39_18_A VARCHAR(40),
	Q39_19_A VARCHAR(40),
	Q39_20_A VARCHAR(40),
	Q39_21_A VARCHAR(40),
	Q39_22_A VARCHAR(40),
	Q39_23_A VARCHAR(40),
	Q40_24_A VARCHAR(40),
	Q39_17_B VARCHAR(20),
	Q39_18_B VARCHAR(20),
	Q39_19_B VARCHAR(20),
	Q39_20_B VARCHAR(20),
	Q39_21_B VARCHAR(20),
	Q39_22_B VARCHAR(20),
	Q39_23_B VARCHAR(20),
	Q40_24_B VARCHAR(20),
	Q39_25_A VARCHAR(40),
	Q39_26_A VARCHAR(40),
	Q39_27_A VARCHAR(40),
	Q39_28_A VARCHAR(40),
	Q39_29_A VARCHAR(40),
	Q39_30_A VARCHAR(40),
	Q39_31_A VARCHAR(40),
	Q43_44_A VARCHAR(40),
	Q39_25_B VARCHAR(20),
	Q39_26_B VARCHAR(20),
	Q39_27_B VARCHAR(20),
	Q39_28_B VARCHAR(20),
	Q39_29_B VARCHAR(20),
	Q39_30_B VARCHAR(20),
	Q39_31_B VARCHAR(20),
	Q43_44_B VARCHAR(20),
	Q44 VARCHAR(50),
	TERMINATION_DATE VARCHAR(10),
	EMPLOYEE_ID VARCHAR(128),
	PARTICIPANT_UNIQUE_IDENTIFIER VARCHAR(128),
	FILENAME VARCHAR(100)
);

create or replace TABLE PO_HRIS_DB."survey".PO_EXIT_SURVEY (
	RECORD_DATE DATE,
	START_DATETIME TIMESTAMP_NTZ(9),
	END_DATETIME TIMESTAMP_NTZ(9),
	STATUS VARCHAR(2),
	PROGRESS NUMBER(38,0),
	DURATION NUMBER(38,0),
	FINISHED BOOLEAN,
	RECORDED_DATE TIMESTAMP_NTZ(9),
	RESPONSE_ID VARCHAR(17),
	TERMINATION_DATE DATE,
	EMPLOYEE_ID VARCHAR(128),
	Q3_374 VARCHAR(40),
	Q3_376 VARCHAR(90),
	Q3_378 VARCHAR(50),
	Q3_388 VARCHAR(30),
	Q3_386 VARCHAR(10),
	Q3_380 VARCHAR(50),
	Q3_381 VARCHAR(40),
	Q3_382 VARCHAR(30),
	Q3_375 VARCHAR(50),
	Q3_377 VARCHAR(70),
	Q3_379 VARCHAR(40),
	Q3_383 VARCHAR(30),
	Q3_384 VARCHAR(30),
	Q3_385 VARCHAR(10),
	Q3_387 VARCHAR(60),
	Q4 VARCHAR(90),
	Q6_4 VARCHAR(110),
	Q6_5 VARCHAR(80),
	Q6_6 VARCHAR(70),
	Q6_7 VARCHAR(80),
	Q6_8 VARCHAR(60),
	Q6_9 VARCHAR(100),
	Q6_10 VARCHAR(80),
	Q6_11 VARCHAR(110),
	Q6_12 VARCHAR(80),
	Q6_13 VARCHAR(80),
	Q6_14 VARCHAR(110),
	Q6_15 VARCHAR(30),
	Q6_15_TEXT VARCHAR,
	Q7 VARCHAR,
	Q9_29 VARCHAR(40),
	Q9_30 VARCHAR(50),
	Q9_31 VARCHAR(60),
	Q9_32 VARCHAR(100),
	Q9_33 VARCHAR(30),
	Q9_34 VARCHAR(40),
	Q9_41 VARCHAR(30),
	Q9_35 VARCHAR(30),
	Q9_36 VARCHAR(20),
	Q9_37 VARCHAR(30),
	Q9_38 VARCHAR(40),
	Q9_39 VARCHAR(30),
	Q9_40 VARCHAR(30),
	Q9_41_TEXT VARCHAR,
	Q10 VARCHAR,
	Q12_61 VARCHAR(30),
	Q12_62 VARCHAR(50),
	Q12_63 VARCHAR(60),
	Q12_64 VARCHAR(20),
	Q12_65 VARCHAR(60),
	Q12_66 VARCHAR(20),
	Q12_67 VARCHAR(20),
	Q12_68 VARCHAR(30),
	Q12_69 VARCHAR(50),
	Q12_79 VARCHAR(30),
	Q12_70 VARCHAR(30),
	Q12_71 VARCHAR(30),
	Q12_72 VARCHAR(50),
	Q12_73 VARCHAR(100),
	Q12_74 VARCHAR(100),
	Q12_75 VARCHAR(100),
	Q12_76 VARCHAR(100),
	Q12_77 VARCHAR(20),
	Q12_78 VARCHAR(30),
	Q12_79_TEXT VARCHAR,
	Q13 VARCHAR,
	Q15_80 VARCHAR(60),
	Q15_81 VARCHAR(90),
	Q15_82 VARCHAR(90),
	Q15_83 VARCHAR(60),
	Q15_88 VARCHAR(30),
	Q15_84 VARCHAR(50),
	Q15_85 VARCHAR(80),
	Q15_86 VARCHAR(100),
	Q15_87 VARCHAR(80),
	Q15_88_TEXT VARCHAR,
	Q16 VARCHAR,
	Q18 VARCHAR,
	Q19 VARCHAR,
	Q20 VARCHAR(20),
	Q21 VARCHAR(70),
	Q23_4 VARCHAR(60),
	Q23_5 VARCHAR(100),
	Q23_6 VARCHAR(50),
	Q23_7 VARCHAR(30),
	Q23_8 VARCHAR(30),
	Q23_9 VARCHAR(30),
	Q23_10 VARCHAR(20),
	Q23_11 VARCHAR(30),
	Q23_12 VARCHAR(40),
	Q23_13 VARCHAR(30),
	Q23_13_TEXT VARCHAR,
	Q24 VARCHAR,
	Q31 VARCHAR(70),
	Q27 VARCHAR(10),
	Q28 VARCHAR(110),
	Q32 VARCHAR(1210),
	Q33_4 VARCHAR(60),
	Q33_5 VARCHAR(60),
	Q33_6 VARCHAR(80),
	Q33_7 VARCHAR(60),
	Q33_8 VARCHAR(70),
	Q33_9 VARCHAR(70),
	Q33_10 VARCHAR(60),
	Q33_11 VARCHAR(60),
	Q33_12 VARCHAR(100),
	Q33_13 VARCHAR(30),
	Q33_13_TEXT VARCHAR,
	Q34 VARCHAR(160),
	Q35 VARCHAR(30),
	Q36 VARCHAR,
	Q37 VARCHAR,
	Q39_1_A VARCHAR(40),
	Q39_2_A VARCHAR(40),
	Q39_3_A VARCHAR(40),
	Q39_4_A VARCHAR(40),
	Q39_5_A VARCHAR(40),
	Q39_6_A VARCHAR(40),
	Q39_7_A VARCHAR(40),
	Q39_8_A VARCHAR(40),
	Q39_1_B VARCHAR(20),
	Q39_2_B VARCHAR(20),
	Q39_3_B VARCHAR(20),
	Q39_4_B VARCHAR(20),
	Q39_5_B VARCHAR(20),
	Q39_6_B VARCHAR(20),
	Q39_7_B VARCHAR(20),
	Q39_8_B VARCHAR(20),
	Q39_9_A VARCHAR(40),
	Q39_10_A VARCHAR(40),
	Q39_11_A VARCHAR(40),
	Q39_12_A VARCHAR(40),
	Q39_13_A VARCHAR(40),
	Q39_14_A VARCHAR(40),
	Q39_15_A VARCHAR(40),
	Q39_16_A VARCHAR(40),
	Q39_9_B VARCHAR(20),
	Q39_10_B VARCHAR(20),
	Q39_11_B VARCHAR(20),
	Q39_12_B VARCHAR(20),
	Q39_13_B VARCHAR(20),
	Q39_14_B VARCHAR(20),
	Q39_15_B VARCHAR(20),
	Q39_16_B VARCHAR(20),
	Q39_17_A VARCHAR(40),
	Q39_18_A VARCHAR(40),
	Q39_19_A VARCHAR(40),
	Q39_20_A VARCHAR(40),
	Q39_21_A VARCHAR(40),
	Q39_22_A VARCHAR(40),
	Q39_23_A VARCHAR(40),
	Q40_24_A VARCHAR(40),
	Q39_17_B VARCHAR(20),
	Q39_18_B VARCHAR(20),
	Q39_19_B VARCHAR(20),
	Q39_20_B VARCHAR(20),
	Q39_21_B VARCHAR(20),
	Q39_22_B VARCHAR(20),
	Q39_23_B VARCHAR(20),
	Q40_24_B VARCHAR(20),
	Q39_25_A VARCHAR(40),
	Q39_26_A VARCHAR(40),
	Q39_27_A VARCHAR(40),
	Q39_28_A VARCHAR(40),
	Q39_29_A VARCHAR(40),
	Q39_30_A VARCHAR(40),
	Q39_31_A VARCHAR(40),
	Q43_44_A VARCHAR(40),
	Q39_25_B VARCHAR(20),
	Q39_26_B VARCHAR(20),
	Q39_27_B VARCHAR(20),
	Q39_28_B VARCHAR(20),
	Q39_29_B VARCHAR(20),
	Q39_30_B VARCHAR(20),
	Q39_31_B VARCHAR(20),
	Q43_44_B VARCHAR(20),
	Q44 VARCHAR(50),
	SOURCE_FILENAME VARCHAR(100),
	CREATED_DATETIME TIMESTAMP_NTZ(9),
	CREATED_BY VARCHAR(100),
	MODIFIED_DATETIME TIMESTAMP_NTZ(9),
	MODIFIED_BY VARCHAR(100),
	BATCH_ID NUMBER(38,0)
);

delete from "PO_STAGE_DB"."survey".po_exit_survey_stage;
delete from "PO_HRIS_DB"."survey".po_exit_survey;

select * from "PO_HRIS_DB"."survey".po_exit_survey;

select *
from "PO_STAGE_DB"."survey".po_exit_survey_stage 
where employee_id is null <> participant_unique_identifier;

call "PO_HRIS_DB"."survey".sp_exit_newhire_load (20231016);


select $1 from @"PO_STAGE_DB"."Worker".worker_load_instg/Exit_Interview.csv (file_format => 'csv_load_format' ) t;

list  @"PO_STAGE_DB"."Worker".worker_load_instg

ALTER SESSION SET  TIMESTAMP_OUTPUT_FORMAT = 'YYYY-MM-DD HH24:MI TZH:TZM';

ALTER SESSION UNSET TIMESTAMP_INPUT_FORMAT = 'YYYY/MM/DD HH24:MI:SS';
SELECT TO_TIMESTAMP('1/28/2020 19:19:00' )

1/28/2020 19:19

UNSET (MIN, MAX)=(40, 70);

SELECT $MIN;


SHOW VARIABLES;

truncate table "PO_HRIS_DB"."survey".po_exit_survey ;
truncate table "PO_STAGE_DB"."survey".po_exit_survey_stage;


select * from "PO_STAGE_DB"."survey".po_exit_survey_stage;
select * from "PO_HRIS_DB"."survey".po_exit_survey ;

select count(*),response_id from "PO_HRIS_DB"."survey".po_exit_survey group by 2 having count(*) > 1 ;


drop pipe  PO_STAGE_DB."survey".QL_PART_ANNIVERSARY;

/*Copy INTO Exit table from S3*/

create or replace pipe PO_STAGE_DB."survey".p_exit_survey_load 
auto_ingest = true 
as
copy into "PO_STAGE_DB"."survey".po_exit_survey_stage
from (select 
$1,
$2,
$3,
$4,
$5,
$6,
$7,
$8,
$9,
$10,
$11,
$12,
$13,
$14,
$15,
$16,
$17,
$18,
$19,
$20,
$21,
$22,
$23,
$24,
$25,
$26,
$27,
$28,
$29,
$30,
$31,
$32,
$33,
$34,
$35,
$36,
$37,
$38,
$39,
$40,
$41,
$42,
$43,
$44,
$45,
$46,
$47,
$48,
$49,
$50,
$51,
$52,
$53,
$54,
$55,
$56,
$57,
$58,
$59,
$60,
$61,
$62,
$63,
$64,
$65,
$66,
$67,
$68,
$69,
$70,
$71,
$72,
$73,
$74,
$75,
$76,
$77,
$78,
$79,
$80,
$81,
$82,
$83,
$84,
$85,
$86,
$87,
$88,
$89,
$90,
$91,
$92,
$93,
$94,
$95,
$96,
$97,
$98,
$99,
$100,
$101,
$102,
$103,
$104,
$105,
$106,
$107,
$108,
$109,
$110,
$111,
$112,
$113,
$114,
$115,
$116,
$117,
$118,
$119,
$120,
$121,
$122,
$123,
$124,
$125,
$126,
$127,
$128,
$129,
$130,
$131,
$132,
$133,
$134,
$135,
$136,
$137,
$138,
$139,
$140,
$141,
$142,
$143,
$144,
$145,
$146,
$147,
$148,
$149,
$150,
$151,
$152,
$153,
$154,
$155,
$156,
$157,
$158,
$159,
$160,
$161,
$162,
$163,
$164,
$165,
$166,
$167,
$168,
$169,
$170,
$171,
$172,
$173,
$174,
$175,
$176,
$177,
$178,
$179,
$180,
$181,
$182,
$183,
$184,
$185,
$186,
$187,
$188,
METADATA$FILENAME
from @PO_STAGE_DB.PUBLIC.MY_S3_STAGE)
pattern = '.*QL_Survey_Exit_Interview_.*20240221_hashed.*csv'
FILE_FORMAT = (  FORMAT_NAME = 'PO_STAGE_DB."Worker".csv_load_format'  TYPE = CSV ) 
;

/*stream for exit*/
create or replace stream PO_STAGE_DB."survey".S_EXIT_SURVEY_LOAD
COPY GRANTS on table "PO_STAGE_DB"."survey".po_exit_survey_stage
APPEND_ONLY = TRUE
;

/*Task for Exit*/
create or replace task PO_HRIS_DB."survey".t_exit_survey_load
Warehouse = po_wh
SCHEDULE = 'USING CRON 0 16-17 * * * America/Chicago'
//Schedule = '1 Minute'
when system$stream_has_data('PO_STAGE_DB."survey".S_EXIT_SURVEY_LOAD')
as 
Call sp_exit_survey_load((to_char(current_date -1,'YYYYMMDD') )::int)
;

SELECT SYSTEM$PIPE_STATUS('PO_STAGE_DB."survey".p_exit_survey_load');

{"executionState":"RUNNING","pendingFileCount":0,"notificationChannelName":"arn:aws:sqs:us-west-2:774708397847:sf-snowpipe-AIDA3IYBYA4L4SILECDOM-aNkeKZnVEdL-KrxSmU0A-w","numOutstandingMessagesOnChannel":1,"lastReceivedMessageTimestamp":"2024-01-16T05:28:58.227Z","lastPulledFromChannelTimestamp":"2024-01-16T06:37:13.173Z"}

ALTER TASK T_EXIT_SURVEY_LOAD RESUME;
ALTER TASK T_EXIT_SURVEY_LOAD suspend;

SHOW TASKS LIKE 't_exit_survey_load';

T_ANNIVERSARY_SURVEY_LOAD
T_EXIT_SURVEY_LOAD
T_NEW_HIRE_14DAY_SURVEY_LOAD
T_NEW_HIRE_SURVEY_LOAD

select (to_char(current_date -1,'YYYYMMDD') )::int

Show streams
drop stream S_NEW_HIRE_SURVEY_LOAD

S_NEW_HIRE_14DAY_SURVEY_LOAD
S_NEW_HIRE_SURVEY_LOAD


select * from PO_HRIS_DB."survey".PO_exit_survey
delete from PO_HRIS_DB."survey".PO_ANNIVERSARY_SURVEY_FY22 where startdate like '{"ImportId":"startDate","timeZone":"America/Denver"}'